<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –í–∏—Ç—Ä–∞—Ç (Smart Client)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –±–∞–Ω–µ—Ä–∞ "Degraded Mode" */
        #connection-banner {
            display: none;
            background: #ffebee; 
            color: #c62828; 
            padding: 15px; 
            text-align: center; 
            border: 1px solid #ef9a9a;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .form-group { margin-bottom: 15px; }
        input { padding: 8px; font-size: 16px; width: 100%; box-sizing: border-box; margin-top: 5px; }
        label { font-weight: bold; }
        
        button { 
            padding: 10px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* –°—Ç–∏–ª—ñ –∫–Ω–æ–ø–æ–∫ —É —Å–ø–∏—Å–∫—É */
        .action-btn {
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }
        .edit-btn { background-color: #FFC107; color: #000; }
        .delete-btn { background-color: #F44336; }
        .cancel-btn { background-color: #9E9E9E; display: none; margin-left: 10px; }

        ul { margin-top: 20px; padding: 0; }
        li { 
            background: #f9f9f9; 
            margin: 5px 0; 
            padding: 10px; 
            list-style: none; 
            border-bottom: 1px solid #ddd; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .item-info { flex-grow: 1; }
        .refresh-btn { background-color: #2196F3; margin-top: 20px; width: 100%; }
    </style>
</head>
<body>

    <div id="connection-banner">
        ‚ö†Ô∏è –ó'—î–¥–Ω–∞–Ω–Ω—è –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–µ. –ü—Ä–∞—Ü—é—î–º–æ –≤ –æ–±–º–µ–∂–µ–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ. –ü–æ–≤—Ç–æ—Ä—é—î–º–æ —Å–ø—Ä–æ–±–∏...
    </div>

    <h1>–ú–æ—ó –≤–∏—Ç—Ä–∞—Ç–∏</h1>

    <div style="border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
        <h3 id="formTitle">–î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</h3>
        <input type="hidden" id="editId"> 

        <div class="form-group">
            <label for="desc">–û–ø–∏—Å:</label>
            <input type="text" id="desc" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∞–≤–∞">
        </div>
        <div class="form-group">
            <label for="amount">–°—É–º–∞ (–≥—Ä–Ω):</label>
            <input type="number" id="amount" placeholder="0.00">
        </div>
        <div style="display: flex;">
            <button id="submitBtn">–î–æ–¥–∞—Ç–∏</button>
            <button id="cancelBtn" class="cancel-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <button id="loadBtn" class="refresh-btn">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
    <ul id="expensesList"></ul>

    <script>
        // --- 1. UI –ï–õ–ï–ú–ï–ù–¢–ò ---
        const banner = document.getElementById('connection-banner');
        const submitBtn = document.getElementById('submitBtn'); 
        const cancelBtn = document.getElementById('cancelBtn');
        const loadBtn = document.getElementById('loadBtn');
        const list = document.getElementById('expensesList');
        const descInput = document.getElementById('desc');
        const amountInput = document.getElementById('amount');
        const editIdInput = document.getElementById('editId');
        const formTitle = document.getElementById('formTitle');

        // --- 2. –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á ---

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function setDegradedMode(isDegraded) {
            banner.style.display = isDegraded ? 'block' : 'none';
        }

        // --- 3. ROBUST FETCH (–ù–µ–∑–ª–∞–º–Ω–∏–π –∑–∞–ø–∏—Ç) ---
        async function robustFetch(url, options = {}, retries = 3) {
            let attempt = 0;
            const isMutation = ['POST', 'PUT', 'DELETE'].includes(options.method);
            const idempotencyKey = isMutation ? (options.headers?.['Idempotency-Key'] || uuidv4()) : undefined;

            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (idempotencyKey) {
                headers['Idempotency-Key'] = idempotencyKey;
            }

            while (attempt <= retries) {
                const controller = new AbortController();
                const timeoutMs = options.timeout || 5000; 
                const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                try {
                    if (attempt > 0) console.log(`üîÑ –°–ø—Ä–æ–±–∞ ${attempt + 1}/${retries + 1}...`);
                    
                    const response = await fetch(url, { ...options, headers, signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        setDegradedMode(false);
                        return response;
                    }

                    if (response.status === 429) {
                        const retryAfter = response.headers.get('Retry-After');
                        const waitTime = retryAfter ? parseInt(retryAfter) * 1000 : 2000;
                        await wait(waitTime);
                        continue;
                    }

                    if (response.status < 500) {
                        const err = await response.json();
                        throw new Error(err.error?.message || `–ü–æ–º–∏–ª–∫–∞ –∫–ª—ñ—î–Ω—Ç–∞: ${response.status}`);
                    }

                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);

                } catch (error) {
                    clearTimeout(timeoutId);
                    const isLastAttempt = attempt === retries;
                    
                    const shouldRetry = error.name === 'AbortError' || 
                                      error.message.includes('Failed to fetch') || 
                                      error.message.includes('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

                    if (!shouldRetry || isLastAttempt) {
                        if (isLastAttempt) setDegradedMode(true);
                        throw error;
                    }

                    const backoff = Math.pow(2, attempt) * 500 + Math.random() * 500;
                    setDegradedMode(true);
                    await wait(backoff);
                    attempt++;
                }
            }
        }

        // --- 4. –ë–Ü–ó–ù–ï–° –õ–û–ì–Ü–ö–ê ---

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É (GET)
        async function loadExpenses() {
            try {
                loadBtn.disabled = true;
                loadBtn.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                list.innerHTML = '';

                const res = await robustFetch('/expenses', { method: 'GET' });
                const expenses = await res.json();

                expenses.forEach(item => {
                    const li = document.createElement('li');
                    
                    const infoSpan = document.createElement('span');
                    infoSpan.className = 'item-info';
                    infoSpan.textContent = `${item.description} ‚Äî ${item.amount} –≥—Ä–Ω (${item.date?.split('T')[0]})`;
                    
                    const btnContainer = document.createElement('div');
                    
                    // –ö–Ω–æ–ø–∫–∞ –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                    const editBtn = document.createElement('button');
                    editBtn.textContent = '‚úèÔ∏è';
                    editBtn.className = 'action-btn edit-btn';
                    editBtn.onclick = () => startEdit(item);

                    // –ö–Ω–æ–ø–∫–∞ –í–∏–¥–∞–ª–∏—Ç–∏
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'üóëÔ∏è';
                    deleteBtn.className = 'action-btn delete-btn';
                    deleteBtn.onclick = () => deleteExpense(item.id);

                    btnContainer.appendChild(editBtn);
                    btnContainer.appendChild(deleteBtn);
                    
                    li.appendChild(infoSpan);
                    li.appendChild(btnContainer);
                    list.appendChild(li);
                });
            } catch (error) {
                console.error(error);
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫.');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫';
            }
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ –û–Ω–æ–≤–ª–µ–Ω–Ω—è (POST / PUT)
        async function handleFormSubmit() {
            const description = descInput.value;
            const amount = parseFloat(amountInput.value);
            const id = editIdInput.value; // –Ø–∫—â–æ —î ID, –∑–Ω–∞—á–∏—Ç—å —Ü–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è

            if (!description || !amount) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

            try {
                if (id) {
                    // --- –û–ù–û–í–õ–ï–ù–ù–Ø (PUT) ---
                    await robustFetch(`/expenses/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ description, amount })
                    });
                    alert('–£—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                } else {
                    // --- –°–¢–í–û–†–ï–ù–ù–Ø (POST) ---
                    await robustFetch('/expenses', {
                        method: 'POST',
                        body: JSON.stringify({ description, amount })
                    });
                    alert('–£—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!');
                }

                resetForm();
                loadExpenses();

            } catch (error) {
                console.error(error);
                alert(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = id ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–î–æ–¥–∞—Ç–∏';
            }
        }

        // –í–∏–¥–∞–ª–µ–Ω–Ω—è (DELETE)
        async function deleteExpense(id) {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?')) return;

            try {
                await robustFetch(`/expenses/${id}`, { method: 'DELETE' });
                // –í–∏–¥–∞–ª—è—î–º–æ –≤—ñ–∑—É–∞–ª—å–Ω–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—å–æ–≥–æ —Å–ø–∏—Å–∫—É (–¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ)
                loadExpenses();
            } catch (error) {
                console.error(error);
                alert(`–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏: ${error.message}`);
            }
        }

        // --- –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –§–û–†–ú–û–Æ ---
        
        function startEdit(item) {
            editIdInput.value = item.id;
            descInput.value = item.description;
            amountInput.value = item.amount;
            
            formTitle.textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É';
            submitBtn.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏';
            cancelBtn.style.display = 'inline-block';
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ —Ñ–æ—Ä–º–∏
            descInput.focus();
        }

        function resetForm() {
            editIdInput.value = '';
            descInput.value = '';
            amountInput.value = '';
            
            formTitle.textContent = '–î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É';
            submitBtn.textContent = '–î–æ–¥–∞—Ç–∏';
            cancelBtn.style.display = 'none';
        }

        // --- –ó–ê–ü–£–°–ö ---
        loadBtn.addEventListener('click', loadExpenses);
        submitBtn.addEventListener('click', handleFormSubmit);
        cancelBtn.addEventListener('click', resetForm);
        
        // Health Check
        async function checkHealth() {
            try {
                await robustFetch('/health', { method: 'GET', timeout: 1000 }, 1);
                console.log("Health check: OK üü¢");
            } catch (e) {
                console.warn("Health check: Failed üî¥");
                setDegradedMode(true);
            }
        }

        checkHealth();
        loadExpenses();

    </script>
</body>
</html>