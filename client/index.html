<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –í–∏—Ç—Ä–∞—Ç (Smart Client)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –±–∞–Ω–µ—Ä–∞ "Degraded Mode" */
        #connection-banner {
            display: none; /* –°—Ö–æ–≤–∞–Ω–∏–π –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
            background: #ffebee; 
            color: #c62828; 
            padding: 15px; 
            text-align: center; 
            border: 1px solid #ef9a9a;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .form-group { margin-bottom: 15px; }
        input { padding: 8px; font-size: 16px; width: 100%; box-sizing: border-box; margin-top: 5px; }
        label { font-weight: bold; }
        
        button { 
            padding: 10px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        ul { margin-top: 20px; padding: 0; }
        li { background: #f9f9f9; margin: 5px 0; padding: 10px; list-style: none; border-bottom: 1px solid #ddd; }
        .refresh-btn { background-color: #2196F3; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="connection-banner">
        ‚ö†Ô∏è –ó'—î–¥–Ω–∞–Ω–Ω—è –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–µ. –ü—Ä–∞—Ü—é—î–º–æ –≤ –æ–±–º–µ–∂–µ–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ. –ü–æ–≤—Ç–æ—Ä—é—î–º–æ —Å–ø—Ä–æ–±–∏...
    </div>

    <h1>–ú–æ—ó –≤–∏—Ç—Ä–∞—Ç–∏</h1>

    <div style="border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
        <h3>–î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</h3>
        <div class="form-group">
            <label for="desc">–û–ø–∏—Å:</label>
            <input type="text" id="desc" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∞–≤–∞">
        </div>
        <div class="form-group">
            <label for="amount">–°—É–º–∞ (–≥—Ä–Ω):</label>
            <input type="number" id="amount" placeholder="0.00">
        </div>
        <button id="submitBtn">–î–æ–¥–∞—Ç–∏</button>
    </div>

    <button id="loadBtn" class="refresh-btn">üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
    <ul id="expensesList"></ul>

    <script>
        // --- 1. UI –ï–õ–ï–ú–ï–ù–¢–ò ---
        const banner = document.getElementById('connection-banner');
        const submitBtn = document.getElementById('submit-btn'); 
        const loadBtn = document.getElementById('loadBtn');
        const list = document.getElementById('expensesList');
        const descInput = document.getElementById('desc');
        const amountInput = document.getElementById('amount');

        // --- 2. –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á ---

        // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä UUID (–¥–ª—è –∫–ª—é—á—ñ–≤ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ)
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (pause)
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // –ü–µ—Ä–µ–º–∏–∫–∞—á —Ä–µ–∂–∏–º—É "Degraded Mode" (–ß–µ—Ä–≤–æ–Ω–∏–π –±–∞–Ω–µ—Ä)
        function setDegradedMode(isDegraded) {
            if (isDegraded) {
                banner.style.display = 'block';
                // –ú–∏ –Ω–µ –±–ª–æ–∫—É—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–≤–Ω—ñ—Å—Ç—é, –∞–ª–µ –ø–æ–ø–µ—Ä–µ–¥–∂–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            } else {
                banner.style.display = 'none';
            }
        }

        // --- 3. ROBUST FETCH (–ù–µ–∑–ª–∞–º–Ω–∏–π –∑–∞–ø–∏—Ç) ---
        // –¶–µ –≥–æ–ª–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∑–∞–≤–¥–∞–Ω–Ω—è: –†–µ—Ç—Ä–∞—ó, –¢–∞–π–º–∞—É—Ç–∏, –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å
        async function robustFetch(url, options = {}, retries = 3) {
            let attempt = 0;
            
            // –Ø–∫—â–æ —Ü–µ POST –∑–∞–ø–∏—Ç, –≥–µ–Ω–µ—Ä—É—î–º–æ –∫–ª—é—á –æ–¥–∏–Ω —Ä–∞–∑.
            // –ü—Ä–∏ —Ä–µ—Ç—Ä–∞—è—Ö (—Å–ø—Ä–æ–±—ñ ‚Ññ2, ‚Ññ3) –∫–ª—é—á –±—É–¥–µ –¢–û–ô –°–ê–ú–ò–ô.
            const isMutation = options.method === 'POST' || options.method === 'PUT';
            const idempotencyKey = isMutation ? (options.headers?.['Idempotency-Key'] || uuidv4()) : undefined;

            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (idempotencyKey) {
                headers['Idempotency-Key'] = idempotencyKey;
            }

            while (attempt <= retries) {
                const controller = new AbortController();
                // –¢–∞–π–º–∞—É—Ç –∫–ª—ñ—î–Ω—Ç–∞: —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –º–æ–≤—á–∏—Ç—å 5 —Å–µ–∫—É–Ω–¥ ‚Äî –æ–±—Ä–∏–≤–∞—î–º–æ
                const timeoutMs = options.timeout || 5000; 
                const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                try {
                    // –Ø–∫—â–æ —Ü–µ –ø–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞, –ª–æ–≥—É—î–º–æ —Ü–µ
                    if (attempt > 0) console.log(`üîÑ –°–ø—Ä–æ–±–∞ ${attempt + 1}/${retries + 1}...`);
                    
                    const response = await fetch(url, {
                        ...options,
                        headers: headers,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId); // –¢–∞–π–º–µ—Ä –Ω–µ –∑–Ω–∞–¥–æ–±–∏–≤—Å—è, –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–∏–π—à–ª–∞

                    // –£—Å–ø—ñ—Ö
                    if (response.ok) {
                        setDegradedMode(false); // –í—Å–µ –¥–æ–±—Ä–µ, —Ö–æ–≤–∞—î–º–æ –±–∞–Ω–µ—Ä
                        return response;
                    }

                    // –û–±—Ä–æ–±–∫–∞ 429 (Too Many Requests)
                    if (response.status === 429) {
                        const retryAfter = response.headers.get('Retry-After');
                        const waitTime = retryAfter ? parseInt(retryAfter) * 1000 : 2000;
                        console.warn(`‚è≥ –õ—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤. –ß–µ–∫–∞—î–º–æ ${waitTime}–º—Å...`);
                        await wait(waitTime);
                        continue; // –ü—Ä–æ–±—É—î–º–æ –∑–Ω–æ–≤—É –±–µ–∑ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Å–ø—Ä–æ–± (–∞–±–æ –∑ –Ω–∏–º)
                    }

                    // –ü–æ–º–∏–ª–∫–∏ –∫–ª—ñ—î–Ω—Ç–∞ (400, 404) –Ω–µ –≤–∏–ø—Ä–∞–≤–ª—è—é—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–æ–º
                    if (response.status < 500) {
                        const err = await response.json();
                        throw new Error(err.error?.message || `–ü–æ–º–∏–ª–∫–∞ –∫–ª—ñ—î–Ω—Ç–∞: ${response.status}`);
                    }

                    // –ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (500) -> –π–¥–µ–º–æ –≤ catch –¥–ª—è –ø–æ–≤—Ç–æ—Ä—É
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);

                } catch (error) {
                    clearTimeout(timeoutId);
                    
                    const isLastAttempt = attempt === retries;
                    
                    // –ß–∏ –≤–∞—Ä—Ç–æ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏? (–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ, —Ç–∞–π–º–∞—É—Ç –∞–±–æ 5xx)
                    const shouldRetry = error.name === 'AbortError' || 
                                      error.message.includes('Failed to fetch') || 
                                      error.message.includes('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

                    if (!shouldRetry || isLastAttempt) {
                        if (isLastAttempt) setDegradedMode(true); // –í—Å–µ –ø–æ–≥–∞–Ω–æ
                        throw error;
                    }

                    // –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ (Backoff): 500ms, 1000ms, 2000ms...
                    const backoff = Math.pow(2, attempt) * 500 + Math.random() * 500;
                    
                    setDegradedMode(true); // –ü–æ–∫–∞–∑—É—î–º–æ –±–∞–Ω–µ—Ä, —â–æ —î –ø—Ä–æ–±–ª–µ–º–∏
                    await wait(backoff);
                    attempt++;
                }
            }
        }

        // --- 4. –ë–Ü–ó–ù–ï–° –õ–û–ì–Ü–ö–ê ---

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É (GET)
        async function loadExpenses() {
            try {
                loadBtn.disabled = true;
                loadBtn.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
                list.innerHTML = '';

                const res = await robustFetch('/expenses', { method: 'GET' });
                const expenses = await res.json();

                expenses.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.description} ‚Äî ${item.amount} –≥—Ä–Ω (${item.date?.split('T')[0]})`;
                    list.appendChild(li);
                });
            } catch (error) {
                console.error(error);
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫';
            }
        }

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–∏—Ç—Ä–∞—Ç–∏ (POST)
        async function addExpense() {
            const description = descInput.value;
            const amount = parseFloat(amountInput.value);

            if (!description || !amount) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!');
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

            try {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ robustFetch. –Ø–∫—â–æ –º–µ—Ä–µ–∂–∞ –±–ª–∏–º–Ω–µ, –≤—ñ–Ω —Å–∞–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø–∏—Ç.
                // –ö–ª—é—á —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ –∑–≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.
                const res = await robustFetch('/expenses', {
                    method: 'POST',
                    body: JSON.stringify({ description, amount })
                });

                const result = await res.json();
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ Request ID (–¥–ª—è –∑–∞–≤–¥–∞–Ω–Ω—è)
                const reqId = res.headers.get('X-Request-Id');
                console.log(`‚úÖ –£—Å–ø—ñ—Ö! Request-ID: ${reqId}`, result);

                // –û—á–∏—â–∞—î–º–æ —Ñ–æ—Ä–º—É
                descInput.value = '';
                amountInput.value = '';
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
                loadExpenses();
                alert('–£—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!');

            } catch (error) {
                console.error(error);
                alert(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '–î–æ–¥–∞—Ç–∏';
            }
        }

        // Health Check –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ (–í–∏–º–æ–≥–∞ 1—Å —Ç–∞–π–º–∞—É—Ç)
        async function checkHealth() {
            try {
                // –¢—É—Ç —Å—Ç–∞–≤–∏–º–æ –∂–æ—Ä—Å—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç 1000–º—Å (1—Å)
                await robustFetch('/health', { method: 'GET', timeout: 1000 }, 1);
                console.log("Health check: OK üü¢");
            } catch (e) {
                console.warn("Health check: Failed üî¥ (Server might be slow or down)");
                setDegradedMode(true);
            }
        }

        // --- 5. –ó–ê–ü–£–°–ö ---
        loadBtn.addEventListener('click', loadExpenses);
        document.getElementById('submitBtn').addEventListener('click', addExpense);
        
        // –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        checkHealth();
        loadExpenses();

    </script>
</body>
</html>